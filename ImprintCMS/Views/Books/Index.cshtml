@model BookCatalog
@{
    ViewBag.Title = Model.Title;
}
<ul id="genremenu">
    <li>@(Model.CurrentGenre == null ? new HtmlString("<strong>" + SitePhrases.LabelAllBooks + "</strong>") : Html.ActionLink(SitePhrases.LabelAllBooks, "index", new { id = UrlParameter.Optional }, null))</li>
    @foreach (var genre in Model.Genres)
    {
        <li>@(genre == Model.CurrentGenre ? new HtmlString("<strong>" + genre.Name + "</strong>") : Html.ActionLink(genre.Name, "index", new { id = genre.Id }))</li>
    }
</ul>
<div id="booklisting">
    @foreach (var group in Model.CurrentBooks.GroupBy(b => b.CachedRightsHoldersText))
    {
        var rightsHolders = group.First().Relations.Where(r => r.Person.IsVisible).OrderBy(r => r.SequenceIdentifier).ToList();
        <div class="book">
            <h2>@if (rightsHolders.Any())
                {
                @Html.RelationLinkOrName(rightsHolders.First())
                    foreach (var relation in rightsHolders.Skip(1))
                    {
                @(" / ")
                @Html.RelationLinkOrName(relation)
                    }
                }
                else
                {
                @("–")
                }
            </h2>
            <ul>
                @foreach (var book in group)
                {
                    <li>
                        @if (book.Editions.Any(e => e.SmallCoverId != null))
                        {
                            <a href="@Url.Action("Details", new { id = book.Id })">@Html.CoverImage(book.Editions.Where(e => e.SmallCoverId != null).OrderBy(e => e.Number).Last())</a>
                        }

                        @Html.ActionLink(book.Title, "Details", new { id = book.Id })
                        @if (!String.IsNullOrWhiteSpace(book.Subtitle))
                        {
                            <br />
                            <span class="subtitle">@book.Subtitle</span>
                        }
                        <br />
                        <br />
                        <span class="releaseyear">@book.CachedReleaseYear</span>
                    </li>
                }
            </ul>
        </div>
    }
</div>
